{% extends 'partials/base.html' %}

{% block styles %}
<!-- <link rel="stylesheet" href="/static/css/prettyPhoto.css"> -->
<link rel="stylesheet" href="/static/my_style.css">
{% endblock styles %}


{% block main-content %}

<header class="header header-normal">
    <div class="container">
        {% include 'partials/navbar.html' %}
    </div><!-- end container -->
</header>

<section class="section db p120">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="tagline-message page-title text-center">
                    <h3>ğŸ“ Update</h3>
                    <ul class="breadcrumb">
                        <li><a href="javascript:void(0)">Edulogy</a></li>
                        <li class="active">Update</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>


<section class="section gb nopadtop">
    <div class="container">
        <div class="boxed boxedp4">

            <div class="row">
                <div class="col-md-6 col-md-offset-3">
                    <div class="section-title text-center form-group">
                        <h4> ğŸ’¾ ê°œì¸ ì •ë³´ ë³€ê²½í•˜ê¸° ğŸ’¾ </h4>
                    </div><!-- end title -->

                    <form class="big-contact-form" name="updateForm" method="POST">
                        {% csrf_token %}

                        <label for="email"> Email address : </label>
                        <input type="email" name="{{ form.email.name }}" id="email" class="form-control" value="{{ form.email.value }}" readonly>
                        <label for="password"> Password : </label>
                        <input type="button" name="{{ form.password.name }}" id="password" class="form-control" value="ë³€ê²½í•˜ê¸°"> 

                        <hr/>

                        <label for="id_name"> Nickname : </label>
                        <input type="text" name="{{ form.username.name }}" id="username" class="form-control" value="{{ form.username.value }}" required>

                        <p>
                            <label for="id_name"> Gender : </label> &nbsp;
                            {% if form.gender.value == 'f' %}
                                <input type="radio" name="{{ form.gender.name }}" value="m"> male <input type="radio" name="{{ form.gender.name }}" value="f" checked> female 
                            {% else %}
                                <input type="radio" name="{{ form.gender.name }}" value="m" checked> male <input type="radio" name="{{ form.gender.name }}" value="f"> female 
                            {% endif %}
                        </p>

                        <label for="id_name"> Date of birth : </label>
                        <input type="date" name="{{ form.birth.name }}" class="form-control" value="{{ form.birth.value|date:'Y-m-d' }}" readonly>

                        <p></p>

                        <label for="id_name"> Preference Genre : </label>
                        <div>
                            {% for genre in genre_list %}
                                {% if forloop.counter == 6 or forloop.counter == 11 or forloop.counter == 16 or forloop.counter == 21 %}
                                <p></p>
                                {% endif %}

                                {% if genre.type in form.preference_genre.value %}
                                    <input type="checkbox" name="pf_genre" value="{{ genre.type }}" checked> {{ genre.type }} &nbsp;&nbsp;
                                {% else %}
                                    <input type="checkbox" name="pf_genre" value="{{ genre.type }}"> {{ genre.type }} &nbsp;&nbsp;
                                {% endif %}
                            {% endfor %}
                        </div>
                        <input type="hidden" name="{{ form.preference_genre.name }}" id="preference_genre">

                        <br>

                        <button type="button" class="btn btn-default" onclick="location.href='{% url 'home' %}'">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="memberUpdate()">Submit</button>
                    </form>
                </div><!-- end col -->
            </div><!-- end row -->
        </div><!-- end container -->
    </div>
</section>

{% endblock main-content %}

{% block scripts %}

<script>

    // ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
    function showErrorMsg(oMsg, msg) {
        oMsg.html(msg);
    }

    // ì˜¤ë¥˜ ë°œìƒí•œ ê°ì²´ë¡œ í¬ì»¤ìŠ¤ ì˜®ê¹€
    function setFocusToInputObject(oInput) {
        oInput.focus();
    }

    function showSuccessMsg(oMsg) {
        oMsg.html(msg);
        oMsg.css('color', 'green');
    }

    // ë¬¸ì œ ì—†ìœ¼ë©´ ì˜¤ë¥˜ ë©”ì‹œì§€ ì—†ì• ê¸°
    function hideMsg(oMsg) {
        oMsg.css('display', 'none');
    }

    // ------------- username ----------------
    var nameFlag = false;

    $("#username").blur(function(){
        nameFlag = false;
        checkName("first");
    });

    function checkName(evnet) {
        if (nameFlag)
            return true;

        var name = $("#username").val();
        var oMsg = $("#nameMsg");
        var oInput = $("#username");

        if (name == "") {
            showErrorMsg(oMsg, "í•„ìˆ˜ ì •ë³´ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            setFocusToInputObject(oInput);
            return false;
        }

        const eValid = (/^[ê°€-í£a-zA-Z0-9]*$/).test(name);
        
        if (!eValid) {
            showErrorMsg(oMsg, "ë‹‰ë„¤ì„ì€ í•œê¸€,ì˜ì–´,ìˆ«ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            setFocusToInputObject(oInput);
            return false;
        }

        nameFlag = false;
        let username = $('input[name=username]').val();
        console.log("ì…ë ¥í•œ nickname : ", username);

        $.ajax({
            type: 'POST',
            url: '/accounts/check-name/',
            data: {username: username},
            success: function (response) {

                if (response.result === 'exist') {
                    showErrorMsg(oMsg, "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”.");
                    setFocusToInputObject(oInput);
                } else {
                    hideMsg(oMsg);
                    nameFlag = true;
                }
            },

            error: function () {
                alert("ì„œë²„ ìš”ì²­ ì‹¤íŒ¨!");
            }
        })

        return true;
    }

    function memberUpdate() {

        var flag = false;

        const g_array = new Array();
        $('input:checkbox[name=pf_genre]:checked').each(function(){
            g_array.push(this.value);
        });

        var pref_genre = $("#preference_genre").val(g_array);

        if (g_array.length < 1 || g_array.length > 3 || pref_genre == "") {
            showErrorMsg($("#genreMsg"), "ì„ í˜¸ ì¥ë¥´ëŠ” ë°˜ë“œì‹œ 1~3ê°œë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
            return;
        } else {
            hideMsg($("#genreMsg"));
        }

        flag = true;

        var form = document.updateForm;
        console.log("email >>>> ", form.email.value);
        console.log("username >>>> ", form.username.value);
        console.log("birth >>>> ", form.birth.value);
        console.log("gender >>>> ", form.gender.value);
        console.log("genre >>>> ", form.preference_genre.value);


        form.action = "/accounts/update/";
        form.submit();

    }

</script>

{% endblock scripts %}