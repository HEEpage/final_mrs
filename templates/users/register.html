{% extends 'partials/base.html' %}

{% block styles %}
<!-- <link rel="stylesheet" href="/static/css/prettyPhoto.css"> -->
<link rel="stylesheet" href="/static/my_style.css">
{% endblock styles %}

{% if message %}
    <script type="text/javascript">
        const txt = "{{ message }}";
        alert(txt);
    </script>
{% endif %}

{% block main-content %}

<!-- LOADER -->
<div id="preloader">
    <img class="preloader" src="/static/images/loader.gif" alt="">
</div><!-- end loader -->
<!-- END LOADER -->

<section class="section db p120">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="tagline-message page-title text-center">
                    <h3>ğŸ‰ Sign Up</h3>
                    <ul class="breadcrumb">
                        <li><a href="javascript:void(0)">Edulogy</a></li>
                        <li class="active">Sign Up</li>
                    </ul>
                </div>
            </div><!-- end col -->
        </div><!-- end row -->
    </div><!-- end container -->
</section><!-- end section -->

<section class="section gb nopadtop">
    <div class="container">
        <div class="boxed boxedp4">

            <div class="row">
                <div class="col-md-6 col-md-offset-3">
                    <div class="section-title text-center form-group">
                        <h4> âœ¨ MRSì™€ í•¨ê»˜ ë‹¤ì–‘í•œ ì˜í™”ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”! âœ¨ </h4>
                    </div><!-- end title -->

                    {% if errors %}
                    <div class="alert alert-danger" id="alertError" name="alertError" role="alert">
                        {% for field in errors %}
                            {{ field.errors }}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <form class="big-contact-form" name="registerForm" method="POST">
                        {% csrf_token %}

                        <label for="email"> Email address : </label>
                        <input type="email" name="{{ form.email.name }}" id="email" class="form-control" placeholder="Enter email" required>
                        <p><small class="error_next_box" id="emailMsg" name="emailMsg" aria-live="assertive" style="color: crimson;"></small></p>

                        <label for="password1"> Password : </label>
                        <input type="password" name="{{ form.password1.name }}" id="password1" class="form-control" placeholder="Enter password" autoComplete="off" required>
                        <p><small class="error_next_box" id="pw1Msg" name="pw1Msg" aria-live="assertive" style="color: crimson;"></small></p>

                        <label for="password2"> Checked Password : </label>
                        <input type="password" name="{{ form.password2.name }}" id="password2" class="form-control" placeholder="Checked password" autoComplete="off" required>
                        <p><small class="error_next_box" id="pw2Msg" name="pw2Msg" aria-live="assertive" style="color: crimson;"></small></p>

                        <hr/>

                        <label for="username"> Nickname : </label>
                        <input type="text" name="{{ form.username.name }}" id="username" class="form-control" placeholder="Enter your name" required>
                        <p><small class="error_next_box" id="nameMsg" name="nameMsg" aria-live="assertive" style="color: crimson;"></small></p>

                        <p>
                            <label> Gender : </label> &nbsp;
                            <input type="radio" name="{{ form.gender.name }}" value="m" checked> male <input type="radio" name="{{ form.gender.name }}" value="f"> female 
                        </p>

                        <p>
                            <label> Date of birth : </label>
                            <input type="date" name="{{ form.birth.name }}" id="birth" class="form-control" required>
                            <p><small class="error_next_box" id="birthMsg" name="birthMsg" aria-live="assertive" style="color: crimson;"></small></p>
                        </p>

                        <label> Preference Genre : </label>
                        <div>
                            {% for genre in genre_list %}
                                {% if forloop.counter == 6 or forloop.counter == 11 or forloop.counter == 16 or forloop.counter == 21 %}
                                <p></p>
                                {% endif %}
                                <input type="checkbox" name="pf_genre" value="{{ genre.type }}"> {{ genre.type }} &nbsp;&nbsp;
                            {% endfor %}
                        </div>
                        <p><small class="error_next_box" id="genreMsg" name="genreMsg" aria-live="assertive" style="color: crimson;"></small></p>
                        <input type="hidden" name="{{ form.preference_genre.name }}" id="preference_genre">

                        <br>

                        <button type="button" class="btn btn-default" onclick="location.href='{% url 'home' %}'">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="memberRegister()">Submit</button>
                    </form>
                </div><!-- end col -->
            </div><!-- end row -->
        </div><!-- end container -->
    </div>
</section>

{% endblock main-content %}

{% block scripts %}

<script>

    // ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
    function showErrorMsg(oMsg, msg) {
        oMsg.html(msg);
    }

    // ì˜¤ë¥˜ ë°œìƒí•œ ê°ì²´ë¡œ í¬ì»¤ìŠ¤ ì˜®ê¹€
    function setFocusToInputObject(oInput) {
        oInput.focus();
    }

    function showSuccessMsg(oMsg) {
        oMsg.html(msg);
        oMsg.css('color', 'green');
    }

    // ë¬¸ì œ ì—†ìœ¼ë©´ ì˜¤ë¥˜ ë©”ì‹œì§€ ì—†ì• ê¸°
    function hideMsg(oMsg) {
        oMsg.css('display', 'none');
    }

    // ------------- E-mail ----------------
    var emailFlag = false;

    $("#email").blur(function(){
        emailFlag = false;
        checkEmail("first");
    });

    function checkEmail(evnet) {
        if (emailFlag)
            return true;

        var email = $("#email").val();
        var oMsg = $("#emailMsg");
        var oInput = $("#email");

        if (email == "") {
            showErrorMsg(oMsg, "í•„ìˆ˜ ì •ë³´ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”!");
            setFocusToInputObject(oInput);
            return false;
        }

        // const eValid = (/^[\w+_]\w+@\w+\.\w+/).test(email);
        const eValid = (/([\w-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/).test(email);
        
        if (!eValid) {
            showErrorMsg(oMsg, "E-mail í˜•ì‹ì— ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”!");
            setFocusToInputObject(oInput);
            return false;
        }

        emailFlag = false;
        let userEmail = $('input[name=email]').val();
        console.log("ì…ë ¥í•œ email : ", userEmail);

        $.ajax({
            type: 'POST',
            url: '/accounts/check-email/',
            data: {email: email},
            success: function (response) {
                // if (response.result !== 'success') {
                //     return
                // }

                if (response.result === 'exist') {
                    showErrorMsg(oMsg, "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ E-mailì…ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”.");
                    setFocusToInputObject(oInput);
                } else {
                    hideMsg(oMsg);
                    emailFlag = true;
                }
            },

            error: function () {
                alert("ì„œë²„ ìš”ì²­ ì‹¤íŒ¨!");
            }
        })

        return true;
    }


    // ------------- password ----------------
    var pw1Flag = false;

    $("#password1").blur(function(){
        // pw1Flag = false;
        pw1Flag = checkPW("first");
    });

    function checkPW(evnet) {
        if (pw1Flag)
            return true;

        var pw1 = $("#password1").val();
        var oMsg = $("#pw1Msg");
        var oInput = $("#password1");

        if (pw1 == "") {
            showErrorMsg(oMsg, "í•„ìˆ˜ ì •ë³´ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”!");
            setFocusToInputObject(oInput);
            return false;
        } 

        const eValid = (/^.*(?=.{6,12})(?=.*[0-9])(?=.*[a-zA-Z]).*$/).test(pw1);
        
        if (!eValid) {
            showErrorMsg(oMsg, "ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ì–´ì™€ ìˆ«ìë¥¼ í¬í•¨í•œ 6~12ìë¦¬ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”!");
            setFocusToInputObject(oInput);
            return false;
        }
        
        hideMsg(oMsg);
        return true;

    }

    // ------------- password check ----------------
    var pw2Flag = false;

    $("#password2").blur(function(){
        pw2Flag = false;
        checkPW2("first");
    });

    function checkPW2(evnet) {
        if (pw2Flag)
            return true;

        var pw1 = $("#password1").val();
        var pw2 = $("#password2").val();
        var oMsg = $("#pw2Msg");
        var oInput1 = $("#password1");
        var oInput2 = $("#password2");

        if (pw1 !== pw2) {
            showErrorMsg(oMsg, "ë¹„ë°€ë²ˆí˜¸ëŠ” ë™ì¼í•˜ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.");
            setFocusToInputObject(oInput2);
            return false;
        } else {
            hideMsg(oMsg);
            return true;
        }

    }


    // ------------- username ----------------
    var nameFlag = false;

    $("#username").blur(function(){
        nameFlag = false;
        checkName("first");
    });

    function checkName(evnet) {
        if (nameFlag)
            return true;

        var name = $("#username").val();
        var oMsg = $("#nameMsg");
        var oInput = $("#username");

        if (name == "") {
            showErrorMsg(oMsg, "í•„ìˆ˜ ì •ë³´ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            setFocusToInputObject(oInput);
            return false;
        }

        const eValid = (/^[ê°€-í£a-zA-Z0-9]*$/).test(name);
        
        if (!eValid) {
            showErrorMsg(oMsg, "ë‹‰ë„¤ì„ì€ í•œê¸€,ì˜ì–´,ìˆ«ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            setFocusToInputObject(oInput);
            return false;
        }

        nameFlag = false;
        let username = $('input[name=username]').val();
        console.log("ì…ë ¥í•œ nickname : ", username);

        $.ajax({
            type: 'POST',
            url: '/accounts/check-name/',
            data: {username: username},
            success: function (response) {

                if (response.result === 'exist') {
                    showErrorMsg(oMsg, "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”.");
                    setFocusToInputObject(oInput);
                } else {
                    hideMsg(oMsg);
                    nameFlag = true;
                }
            },

            error: function () {
                alert("ì„œë²„ ìš”ì²­ ì‹¤íŒ¨!");
            }
        })

        return true;
    }

    function memberRegister() {

        var form = document.registerForm;

        var birthFlag = false;
        var birth = $("#birth").val();

        console.log("birth test >>>>>> ", birth);

        if (birth == "") {
            showErrorMsg($("#birthMsg"), "í•„ìˆ˜ ì •ë³´ì…ë‹ˆë‹¤. ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            setFocusToInputObject($("#birth"));
            birthFlag = false;
            return;
        } else {
            hideMsg($("#birthMsg"));
            birthFlag = true;
        }

        var genreFlag = false;
        const g_array = new Array();
        $('input:checkbox[name=pf_genre]:checked').each(function(){
            g_array.push(this.value);
        });

        var pref_genre = $("#preference_genre").val(g_array);

        if (g_array.length < 1 || g_array.length > 3 || pref_genre == "") {
            showErrorMsg($("#genreMsg"), "ì„ í˜¸ ì¥ë¥´ëŠ” ë°˜ë“œì‹œ 1~3ê°œë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
            genreFlag = false;
            return;
        } else {
            hideMsg($("#genreMsg"));
            genreFlag = true;
        }

        form.action = "/accounts/register/";
        form.submit();

    }

</script>
{% endblock scripts %}